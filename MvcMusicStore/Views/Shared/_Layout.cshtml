@using Twilio;
@{
    var capability = new TwilioCapability(MvcMusicStore.Credentials.AccountSid, MvcMusicStore.Credentials.AuthToken);
    capability.AllowClientOutgoing(MvcMusicStore.Credentials.AppSid);
    string token = capability.GenerateToken();
}
    
<!DOCTYPE html>
<html>
<head>
    <title>@ViewBag.Title</title>
    <link href="@Url.Content("~/Content/Site.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/themes/base/jquery.ui.all.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/themes/base/jquery.ui.dialog.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/themes/base/jquery.ui.theme.css")" rel="stylesheet" type="text/css" />

    <script src="@Url.Content("~/Scripts/jquery-1.7.1.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery-ui-1.8.18.min.js")" type="text/javascript"></script>

    <script type="text/javascript">
        $(function () {
            $("#click2call").dialog({ autoOpen: false });
        });

        function openc2c() {
            var c2c = $('#click2call')
            c2c.dialog('open');
        }
    </script>

    <script type="text/javascript" src="http://static.twilio.com/libs/twiliojs/1.0/twilio.min.js"></script>        

    <script type="text/javascript">

        Twilio.Device.setup('@token');

        Twilio.Device.ready(function (device) {
            $("#log").text("Ready");
        });

        Twilio.Device.error(function (error) {
            $("#log").text("Error: " + error.message);
        });

        Twilio.Device.connect(function (conn) {
            $("#log").text("Successfully established call");
        });

        Twilio.Device.disconnect(function (conn) {
            $("#log").text("Call ended");
        });

        Twilio.Device.incoming(function (conn) {
            $("#log").text("Incoming connection from " + conn.parameters.From);
            // accept the incoming connection and start two-way audio
            conn.accept();
        });

        function call() {
            // get the phone number to connect the call to
            params = { "PhoneNumber": $("#number").val() };
            Twilio.Device.connect(params);
        }

        function hangup() {
            Twilio.Device.disconnectAll();
        }
    </script>
</head>
<body>
    <div id="header">
        <h1><a href="/">ASP.NET MVC MUSIC STORE</a></h1>
        <ul id="navlist">
            <li class="first"><a href="@Url.Content("~")" id="current">Home</a></li>
            <li><a href="@Url.Content("~/Store/")">Store</a></li>
            <li>@{Html.RenderAction("CartSummary", "ShoppingCart");}</li>
            
            <li><a href="@Url.Content("~/StoreManager/")">Admin</a></li>
            <li><a href="#" onclick="openc2c();">Talk to us!</a></li>
            @if (Request.IsAuthenticated)
            { 
                <li>@Html.ActionLink("Log Off", "LogOff", "Account")</li>
            }
        </ul>        
    </div>

    @{Html.RenderAction("GenreMenu", "Store");}

    <div id="main">
        @RenderBody()
    </div>

    <div id="footer">
        built with <a href="http://asp.net/mvc">ASP.NET MVC 3</a>
    </div>

    <div id="click2call" title="Basic dialog">
        <button onclick="call();">
            Call
        </button>  
        <button onclick="hangup();">
            Hangup
        </button>
	    <p><div id="log">Loading pigeons...</div></p>
    </div>

</body>
</html>